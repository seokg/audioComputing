<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title> Audio Visualization </title>
</head>
<body>		
	<h1> Mini Project #1: Loudness Mapping </h1>
	
	<input id="fileChooseInput" type="file"></input>
	<button onclick="playSound(myAudioBuffer)">Play</button>
	<button onclick="stopSound()">Stop</button>	  

	<p><canvas id='wave_view' style="background: white;"></canvas></p>

	<script>	
	var context;
	var myAudioBuffer = null;
	var analyser;
	////////////////////////////
	// variable AUDIO LOUDNESS//
	////////////////////////////
	var norm_data;
	var amp_scale = 100;
	var sensitivity = 0.05;
	var current_level;
	var power;
	var decay_coef = 0.99;
	////////////////////////////
	// variable MIDI-NOTE///////
	////////////////////////////
	var source;
	var spec_view;

	var PITCH_MIN = 36;
	var PITCH_MAX = 108;
	var PITCH_STEP = 1;
	var pitch_range = [];
	var pitch_range_hz = [];
	////////////////////////////
	// variable for orb ////////
	////////////////////////////
	var drawContext = wave_view.getContext('2d');
	drawContext.lineCap = 'round';
	var rand = function(rMi, rMa){return ~~((Math.random()*(rMa-rMi+1))+rMi);} // Math.random: 0 ~ 1
	var orbs = [];
	var orbCount = 30;
	var radius;

	////////////////////////////

	var wave_view;
	var WIDTH = 512;
	var HEIGHT = 512;
	
	var amp_envelop = 0;



	///////////////////////////
	// orb function ///////////
	///////////////////////////
	function createOrb(mx,my){
	  var dx = (WIDTH/2) - mx;
		var dy = (HEIGHT/2) - my;
		var dist = Math.sqrt(dx * dx + dy * dy);
		var angle = Math.atan2(dy, dx);
		orbs.push({
			x: mx,
			y: my,
			lastX: mx,
			lastY: my,
			hue: 0,
			colorAngle: 0,
			angle: angle + Math.PI/2,
			//size: .5+dist/250,
			size: rand(1,3)/2,
			centerX: WIDTH/2,
			centerY: HEIGHT/2,		
			radius: dist,
			speed: (rand(5,10)/1000)*(dist/750)+.015,
			alpha: 1 - Math.abs(dist)/WIDTH,
			draw: function() {			
				drawContext.strokeStyle = 'hsla('+this.colorAngle+',100%,50%,1)';	
				drawContext.lineWidth = this.size;			
				drawContext.beginPath();
				drawContext.moveTo(this.lastX, this.lastY);
				drawContext.lineTo(this.x, this.y);
				drawContext.stroke();
			},	
			update: function(){
				var mx = this.x;
				var my = this.y;	
				this.lastX = this.x;
				this.lastY = this.y;
				var x1 = WIDTH/2;
				var y1 = HEIGHT/2;
				var x2 = mx;
				var y2 = my;		
				var rise = y1-y2;
				var run = x1-x2;
				var slope = -(rise/run);
				var radian = Math.atan(slope);
				var angleH = Math.floor(radian*(180/Math.PI));		
				if(x2 < x1 && y2 < y1){angleH += 180;}		
				if(x2 < x1 && y2 > y1){angleH += 180;}		
				if(x2 > x1 && y2 > y1){angleH += 360;}		
				if(y2 < y1 && slope =='-Infinity'){angleH = 90;}		
				if(y2 > y1 && slope =='Infinity'){angleH = 270;}		
				if(x2 < x1 && slope =='0'){angleH = 180;}
				if(isNaN(angleH)){angleH = 0;}
				
				this.colorAngle = angleH;
				this.x = this.centerX + Math.sin(this.angle*-1) * this.radius;
				this.y = this.centerY + Math.cos(this.angle*-1) * this.radius;
				this.angle += this.speed;
			
			}
		});
	}



	window.onload=function(){
		// file open button
		var control = document.getElementById("fileChooseInput");
		control.addEventListener("change", fileChanged, false);
		
		// canvas 
		wave_view = document.getElementById("wave_view");
		wave_view.width =  WIDTH;
		wave_view.height = HEIGHT;
		
		// create audio context
		context = new AudioContext();
		
		// analyzer
	    analyser = context.createAnalyser();
	    analyser.fftSize = 256;
		analyser.smoothingTimeConstant = 0;		

		for (var pitch = PITCH_MIN; pitch <= PITCH_MAX; pitch = pitch + PITCH_STEP) 
		{
			pitch_range.push(pitch);
			pitch_range_hz.push(midi2hertz(pitch))
		}	
	}


	function midi2hertz(midi) {
		var hertz;
		///// YOUR CODE IS HERE /////
		hertz = (Math.pow(2,(midi-69)/12)) * 440;	
		/////////////////////////////
		return hertz;
	}
	
	function draw_wave(timestamp) {		
		// 2d canvas context		
		// fill rectangular
		drawContext.clearRect(0, 0, WIDTH, HEIGHT);
		drawContext.fillStyle = 'rgb(225, 225, 225)';
		drawContext.fillRect(0, 0, WIDTH, HEIGHT);
		
		///// Time Domain  /////
		var dataArray_TimeDomain = new Float32Array(analyser.frequencyBinCount);
		analyser.getFloatTimeDomainData(dataArray_TimeDomain);

		power = 100 * Math.pow (dataArray_TimeDomain[0] ,2);
		current_level = amp_scale*Math.log(1.0 + 1.0/sensitivity*power)/Math.log(1.0 + 1.0/sensitivity);

		if (current_level>amp_envelop){
			amp_envelop = current_level;
		}
		else{
			amp_envelop = decay_coef* amp_envelop;
		}
		///// Frequnecy Domain  /////
		var dataArray_FreqDomain = new Unit8Array(analywer.frequencyBinCount);
		analyser.getFloatFrequencyData(dataArray_FreqDomain)
		var midi_power = new Uint8Array(pitch_range_hz.length);
		var sample_rate = 44100.0;

		for (var i =1 ; i<midi_power.length-1; i++){
			var idx = pitch_range_hz [i] *analyser.fftSize/ (0.5*sample_rate);
			idx = Math.round(idx);
			console.log(idx);
			midi_power[i] = dataArray_FreqDomain[idx];
		}

		var sample_rate = 44100.0;
		
	}



	////////////////////////////
	// loop for dawing  ////////
	////////////////////////////


	var count = PITCH_MAX - PITCH_MIN; // need to be changed to frequency size
	while(count--){
			createOrb(cw/2, ch/2+(count*2)); // creaing orbs
	}

	var loop = function(){
	  window.requestAnimFrame(loop);
		if(1){ // trailing circle: make it always true
			drawContext.fillStyle = 'rgba(0,0,0,.1)';
			drawContext.fillRect(0,0,WIDTH,HEIGHT);
		} 
		var i = orbs.length;
		while(i--){	
			var orb = orbs[i];	
			var updateCount = 3;
			while(updateCount--){
			orb.update();		
			orb.draw(drawContext)
			}
		}
	}







//////////////////////////////////////////////////////////
// not need to be change from this line //////////////////
//////////////////////////////////////////////////////////
	function fileChanged(e){
		var file = e.target.files[0];
		var fileReader = new FileReader();
		fileReader.onload = fileLoaded;
		fileReader.readAsArrayBuffer(file);
	}

	function fileLoaded(e){
	    context.decodeAudioData(e.target.result, function(buffer) {
	      myAudioBuffer = buffer;
	      playSound();
	    });
	}

	var source = null;


	// as the audio play the visualization starts to appear
	function playSound(myAudioBuffer) {
	  source = context.createBufferSource();
	  source.buffer = myAudioBuffer;
	  source.connect(context.destination);
	  
	  // connect source to analyser
	  source.connect(analyser);
	  
	  source.start();
	  
	  // visualize audio//////////////////////////////////////////
	  loop();
	}

	function stopSound() {
	  if (source) {
	    source.stop();
	  }
	}	   	
	</script>
</body>
</html>
